from zipfile import ZipFile
from pathlib import Path

# Recriar estrutura após reset
project_dir = Path("/mnt/data/chat_pwa_firebase")
project_dir.mkdir(exist_ok=True)

# Conteúdo dos arquivos
index_html = """
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meu Chat PWA</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#075e54" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; background: #ece5dd; }
    #login-screen, #chat-screen { display: none; padding: 20px; }
    #login-screen { display: flex; flex-direction: column; align-items: center; }
    input, button { margin: 5px; padding: 10px; }
    #chat-screen { display: flex; flex-direction: column; height: 100vh; }
    #messages { flex: 1; overflow-y: auto; padding: 10px; }
    .sent { background: #dcf8c6; text-align: right; }
    .received { background: #fff; }
    .message { padding: 10px; border-radius: 5px; margin: 5px; }
  </style>
</head>
<body>
  <div id="login-screen">
    <h2>Entrar no Chat</h2>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Senha" />
    <input type="file" id="avatar" accept="image/*" />
    <button id="loginBtn">Entrar / Registrar</button>
    <div id="error" style="color:red;"></div>
  </div>
  <div id="chat-screen">
    <button id="logoutBtn">Sair</button>
    <div id="messages"></div>
    <input type="text" id="message" placeholder="Digite sua mensagem" />
    <button id="sendBtn">Enviar</button>
  </div>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAb3NOMIUO-zQ9QaGIXwV8ty38cN9Yl2Gg",
    authDomain: "chat-on-1-4f38f.firebaseapp.com",
    databaseURL: "https://chat-on-1-4f38f-default-rtdb.firebaseio.com",
    projectId: "chat-on-1-4f38f",
    storageBucket: "chat-on-1-4f38f.appspot.com",
    messagingSenderId: "499742357573",
    appId: "1:499742357573:web:0cf2bed752f4e1cbb74b2c"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const avatarInput = document.getElementById("avatar");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const messageInput = document.getElementById("message");
  const sendBtn = document.getElementById("sendBtn");
  const messagesDiv = document.getElementById("messages");
  const loginScreen = document.getElementById("login-screen");
  const chatScreen = document.getElementById("chat-screen");
  const errorDiv = document.getElementById("error");

  let currentUser = null;

  function showChat() {
    loginScreen.style.display = "none";
    chatScreen.style.display = "flex";
  }

  function showLogin() {
    chatScreen.style.display = "none";
    loginScreen.style.display = "flex";
  }

  loginBtn.onclick = async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    const avatar = avatarInput.files[0];
    if (!email || !password) {
      errorDiv.textContent = "Preencha email e senha.";
      return;
    }
    try {
      const cred = await auth.signInWithEmailAndPassword(email, password);
      currentUser = cred.user;
      showChat();
    } catch (err) {
      if (err.code === "auth/user-not-found") {
        try {
          const cred = await auth.createUserWithEmailAndPassword(email, password);
          currentUser = cred.user;
          let photoURL = "https://i.imgur.com/xx7JfUD.png";
          if (avatar) {
            const ref = storage.ref("avatars/" + currentUser.uid);
            await ref.put(avatar);
            photoURL = await ref.getDownloadURL();
          }
          await currentUser.updateProfile({ displayName: email.split('@')[0], photoURL });
          showChat();
        } catch (e) {
          errorDiv.textContent = "Erro ao criar: " + e.message;
        }
      } else {
        errorDiv.textContent = "Erro no login: " + err.message;
      }
    }
  };

  logoutBtn.onclick = () => {
    auth.signOut();
    showLogin();
  };

  sendBtn.onclick = () => {
    const msg = messageInput.value.trim();
    if (msg && currentUser) {
      db.ref("messages").push({
        uid: currentUser.uid,
        name: currentUser.displayName,
        avatar: currentUser.photoURL,
        text: msg,
        time: Date.now()
      });
      messageInput.value = "";
    }
  };

  db.ref("messages").on("child_added", snap => {
    const m = snap.val();
    const div = document.createElement("div");
    div.className = "message " + (m.uid === (currentUser && currentUser.uid) ? "sent" : "received");
    div.innerHTML = `<strong>${m.name}:</strong> ${m.text}`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });

  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      showChat();
    } else {
      showLogin();
    }
  });
</script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js');
  }
</script>
</body>
</html>
"""

manifest_json = """
{
  "name": "Meu Chat PWA",
  "short_name": "ChatPWA",
  "start_url": ".",
  "display": "standalone",
  "background_color": "#075e54",
  "theme_color": "#075e54",
  "icons": [
    {
      "src": "icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
"""

service_worker = """
const CACHE_NAME = "chat-pwa-cache-v1";
const urlsToCache = ["/", "/index.html", "/manifest.json"];

self.addEventListener("install", event => {
  event.waitUntil(
    caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
  );
});

self.addEventListener("fetch", event => {
  event.respondWith(
    caches.match(event.request).then(response => response || fetch(event.request))
  );
});
"""

# Criar arquivos
(project_dir / "index.html").write_text(index_html, encoding="utf-8")
(project_dir / "manifest.json").write_text(manifest_json, encoding="utf-8")
(project_dir / "service-worker.js").write_text(service_worker, encoding="utf-8")

# Criar ícones de exemplo
for size in [192, 512]:
    (project_dir / f"icon-{size}x{size}.png").write_bytes(b"\x89PNG\r\n\x1a\n")

# Gerar ZIP
zip_path = Path("/mnt/data/chat_pwa_firebase.zip")
with ZipFile(zip_path, "w") as zipf:
    for file in project_dir.rglob("*"):
        zipf.write(file, arcname=file.relative_to(project_dir))

zip_path
