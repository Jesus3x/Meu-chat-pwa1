<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chat Firebase - Completo Dark + Emojis + √Åudio + Imagens</title>
<meta name="theme-color" content="#075e54" />
<link rel="manifest" href="/manifest.json" />

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<style>
  /* Reset */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; font-family: Arial, sans-serif; background-color: #121b22; color: #eee;
    display: flex; flex-direction: column; height: 100vh;
  }
  /* Login */
  #login-screen {
    background-color: #075e54;
    display: flex; flex-direction: column; justify-content: center; align-items: center; 
    height: 100vh; padding: 20px; color: white;
  }
  #login-screen h2 {
    font-weight: 700; margin-bottom: 30px; font-size: 28px;
  }
  #login-screen input {
    width: 280px; padding: 12px 15px; margin-bottom: 15px; border-radius: 25px; border: none;
    font-size: 16px; outline: none;
  }
  #login-screen input::placeholder {
    color: #a0d6b4;
  }
  #login-screen button {
    width: 280px; padding: 14px 0; background-color: #25d366; border: none;
    border-radius: 25px; font-size: 18px; font-weight: 700; color: white; cursor: pointer;
    transition: background-color 0.3s;
  }
  #login-screen button:hover {
    background-color: #128c4a;
  }
  #error-message {
    margin-top: 10px; min-height: 18px; color: #ff6b6b;
  }

  /* Chat Screen */
  #chat-screen {
    flex: 1; display: flex; flex-direction: column; background: #1e2a33;
  }
  header {
    display: flex; justify-content: space-between; align-items: center; padding: 10px 15px;
    background: #075e54; color: white;
  }
  .user-info {
    display: flex; align-items: center; gap: 10px;
  }
  .user-info img {
    width: 36px; height: 36px; border-radius: 50%;
    object-fit: cover;
  }
  #user-name {
    font-weight: 700; font-size: 18px;
  }
  #logout-btn {
    background: transparent; border: none; color: white; font-size: 22px; cursor: pointer;
  }
  
  /* Messages */
  #messages {
    flex: 1; padding: 15px; overflow-y: auto; background: #152028;
    display: flex; flex-direction: column;
    scrollbar-width: thin; scrollbar-color: #444 #152028;
  }
  #messages::-webkit-scrollbar {
    width: 8px;
  }
  #messages::-webkit-scrollbar-track {
    background: #152028;
  }
  #messages::-webkit-scrollbar-thumb {
    background-color: #444; border-radius: 4px;
  }

  .msg {
    margin: 8px 0; padding: 10px 14px; border-radius: 15px; max-width: 60%;
    display: flex; flex-direction: column;
    word-break: break-word;
  }
  .sent {
    background: #25d366;
    color: #042e00;
    align-self: flex-end;
    border-bottom-right-radius: 2px;
  }
  .received {
    background: #1a2832;
    color: #eee;
    align-self: flex-start;
    border-bottom-left-radius: 2px;
  }
  .msg-header {
    display: flex; align-items: center; gap: 8px; font-size: 0.75em; margin-bottom: 4px;
  }
  .msg-header img {
    width: 24px; height: 24px; border-radius: 50%;
    object-fit: cover;
  }
  .msg .text {
    white-space: pre-wrap;
  }
  audio {
    margin-top: 5px; width: 100%; outline: none;
    border-radius: 8px;
  }
  img.chat-image {
    max-width: 100%; border-radius: 12px; margin-top: 6px;
  }

  /* Input Area */
  .input-area {
    display: flex; align-items: center; padding: 10px 15px; background: #152028;
    gap: 8px;
  }
  #message-input {
    flex: 1; padding: 12px 15px; font-size: 16px; border-radius: 20px; border: none;
    outline: none; background: #23414d; color: #eee;
  }
  #message-input::placeholder {
    color: #bbb;
  }

  /* Buttons */
  .btn-circle {
    width: 44px; height: 44px; border-radius: 50%; border: none; cursor: pointer;
    display: flex; justify-content: center; align-items: center;
    font-size: 22px; user-select: none;
  }
  #send-btn {
    background-color: #25d366; color: #042e00;
  }
  #send-btn:disabled {
    background-color: #799c83; cursor: default;
  }
  #audio-btn {
    background-color: #25d366; color: white; transition: background-color 0.3s;
  }
  #audio-btn.recording {
    background-color: #cc3333;
    animation: pulse 1.2s infinite;
  }
  #image-btn {
    background-color: #128c4a; color: white;
  }
  #emoji-btn {
    background-color: #128c4a; color: white;
  }
  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(204, 51, 51, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(204, 51, 51, 0); }
    100% { box-shadow: 0 0 0 0 rgba(204, 51, 51, 0); }
  }

  /* Status "digitando..." */
  #typing-status {
    padding-left: 15px; height: 20px; font-style: italic; color: #ccc;
    font-size: 14px; min-height: 20px;
  }

  /* Emoji picker */
  #emoji-picker {
    position: absolute;
    bottom: 70px;
    right: 70px;
    background: #23414d;
    border-radius: 10px;
    padding: 10px;
    display: none;
    max-width: 280px;
    max-height: 200px;
    overflow-y: auto;
    box-shadow: 0 0 10px #000;
    user-select: none;
  }
  #emoji-picker span {
    font-size: 24px;
    margin: 5px;
    cursor: pointer;
  }
  #emoji-picker span:hover {
    background: #128c4a;
    border-radius: 5px;
  }
</style>
</head>
<body>

<!-- Tela de Login -->
<div id="login-screen">
  <h2>Entre no Chat</h2>
  <div id="error-message"></div>
  <input type="email" id="email-input" placeholder="Email" autocomplete="username" />
  <input type="password" id="password-input" placeholder="Senha" autocomplete="current-password" />
  <input type="file" id="avatar-input" accept="image/*" />
  <button id="login-btn">Entrar / Registrar</button>
</div>

<!-- Tela de Chat -->
<div id="chat-screen" style="display:none; flex-direction: column; height: 100vh;">
  <header>
    <div class="user-info">
      <img id="user-avatar" src="" alt="Foto de perfil" />
      <span id="user-name"></span>
    </div>
    <button id="logout-btn" title="Sair do chat">‚éã</button>
  </header>

  <div id="messages"></div>
  <div id="typing-status"></div>

  <div class="input-area">
    <button id="emoji-btn" class="btn-circle" title="Selecionar emoji">üòä</button>
    <input type="text" id="message-input" placeholder="Digite uma mensagem" autocomplete="off" />
    <button id="image-btn" class="btn-circle" title="Enviar imagem">üìé</button>
    <button id="audio-btn" class="btn-circle" title="Segure para gravar √°udio">üé§</button>
    <button id="send-btn" class="btn-circle" title="Enviar mensagem" disabled>‚û§</button>
  </div>

  <input type="file" id="image-input" accept="image/*" style="display:none" />

  <div id="emoji-picker"></div>
</div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAb3NOMIUO-zQ9QaGIXwV8ty38cN9Yl2Gg",
    authDomain: "chat-on-1-4f38f.firebaseapp.com",
    databaseURL: "https://chat-on-1-4f38f-default-rtdb.firebaseio.com",
    projectId: "chat-on-1-4f38f",
    storageBucket: "chat-on-1-4f38f.appspot.com",
    messagingSenderId: "499742357573",
    appId: "1:499742357573:web:0cf2bed752f4e1cbb74b2c",
    measurementId: "G-BMZW4Q4PDJ"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();
  const messagesRef = db.ref("messages");
  const typingRef = db.ref("typing");

  // Elementos
  const loginScreen = document.getElementById('login-screen');
  const chatScreen = document.getElementById('chat-screen');
  const emailInput = document.getElementById('email-input');
  const passwordInput = document.getElementById('password-input');
  const avatarInput = document.getElementById('avatar-input');
  const loginBtn = document.getElementById('login-btn');
  const errorMessage = document.getElementById('error-message');

  const userAvatar = document.getElementById('user-avatar');
  const userNameDisplay = document.getElementById('user-name');
  const logoutBtn = document.getElementById('logout-btn');

  const messagesContainer = document.getElementById('messages');
  const messageInput = document.getElementById('message-input');
  const sendBtn = document.getElementById('send-btn');
  const audioBtn = document.getElementById('audio-btn');
  const imageBtn = document.getElementById('image-btn');
  const imageInput = document.getElementById('image-input');
  const emojiBtn = document.getElementById('emoji-btn');
  const emojiPicker = document.getElementById('emoji-picker');
  const typingStatus = document.getElementById('typing-status');

  let currentUser = null;
  let messagesListener = null;
  let mediaRecorder = null;
  let audioChunks = [];
  let typingTimeout;

  // Fun√ß√µes UI
  function showLogin() {
    loginScreen.style.display = 'flex';
    chatScreen.style.display = 'none';
  }
  function showChat() {
    loginScreen.style.display = 'none';
    chatScreen.style.display = 'flex';
    userNameDisplay.textContent = currentUser.displayName || currentUser.email;
    userAvatar.src = currentUser.photoURL || 'https://i.imgur.com/xx7JfUD.png';
    messageInput.focus();
  }

  // Upload avatar
  async function uploadAvatar(uid, file) {
    const avatarRef = storage.ref().child(`avatars/${uid}.jpg`);
    await avatarRef.put(file);
    return await avatarRef.getDownloadURL();
  }

  // Login / Registro
  loginBtn.onclick = async () => {
    errorMessage.textContent = '';
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    const avatarFile = avatarInput.files[0];

    if (!email || !password) {
      errorMessage.textContent = 'Email e senha s√£o obrigat√≥rios';
      return;
    }
    try {
      const cred = await auth.signInWithEmailAndPassword(email, password);
      currentUser = cred.user;
      if (!currentUser.photoURL && avatarFile) {
        const url = await uploadAvatar(currentUser.uid, avatarFile);
        await currentUser.updateProfile({ photoURL: url });
      }
      showChat();
    } catch (e) {
      if (e.code === 'auth/user-not-found') {
        try {
          const cred = await auth.createUserWithEmailAndPassword(email, password);
          currentUser = cred.user;
          const displayName = email.split('@')[0];
          let photoURL = 'https://i.imgur.com/xx7JfUD.png';
          if (avatarFile) {
            photoURL = await uploadAvatar(currentUser.uid, avatarFile);
          }
          await currentUser.updateProfile({ displayName, photoURL });
          showChat();
        } catch (regErr) {
          errorMessage.textContent = regErr.message;
        }
      } else {
        errorMessage.textContent = e.message;
      }
    }
  };

  // Logout
  logoutBtn.onclick = async () => {
    if (confirm('Deseja sair do chat?')) {
      await auth.signOut();
      currentUser = null;
      messagesContainer.innerHTML = '';
      if (messagesListener) {
        messagesRef.off('child_added', messagesListener);
        messagesListener = null;
      }
      showLogin();
    }
  };

  // Render mensagem
  function renderMessage(key, msg) {
    if (!msg.text && !msg.audio && !msg.image) return;

    const isSent = currentUser && msg.uid === currentUser.uid;
    const div = document.createElement('div');
    div.className = 'msg ' + (isSent ? 'sent' : 'received');

    const header = document.createElement('div');
    header.className = 'msg-header';

    const img = document.createElement('img');
    img.src = msg.avatar || 'https://i.imgur.com/xx7JfUD.png';

    const name = document.createElement('span');
    name.textContent = msg.name;

    const time = document.createElement('span');
    const d = new Date(msg.time);
    time.textContent = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    header.appendChild(img);
    header.appendChild(name);
    header.appendChild(time);

    div.appendChild(header);

    if (msg.text) {
      const text = document.createElement('div');
      text.className = 'text';
      text.textContent = msg.text;
      div.appendChild(text);
    }
    if (msg.audio) {
      const audio = document.createElement('audio');
      audio.controls = true;
      audio.src = msg.audio;
      div.appendChild(audio);
    }
    if (msg.image) {
      const image = document.createElement('img');
      image.src = msg.image;
      image.className = 'chat-image';
      div.appendChild(image);
    }
    messagesContainer.appendChild(div);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  // Start escuta mensagens
  function startListeningMessages() {
    messagesContainer.innerHTML = '';
    if (messagesListener) {
      messagesRef.off('child_added', messagesListener);
    }
    messagesListener = messagesRef.on('child_added', snap => {
      renderMessage(snap.key, snap.val());
    });
  }

  // Enviar mensagem texto
  function sendMessage() {
    const text = messageInput.value.trim();
    if (!text || !currentUser) return;
    const msg = {
      uid: currentUser.uid,
      name: currentUser.displayName || currentUser.email,
      avatar: currentUser.photoURL || '',
      text,
      time: Date.now()
    };
    messagesRef.push(msg);
    messageInput.value = '';
    sendBtn.disabled = true;
    updateTyping(false);
  }

  // Envio Imagem
  imageBtn.onclick = () => imageInput.click();
  imageInput.onchange = async e => {
    const file = e.target.files[0];
    if (!file || !currentUser) return;
    const fileRef = storage.ref().child(`images/${currentUser.uid}_${Date.now()}_${file.name}`);
    try {
      await fileRef.put(file);
      const url = await fileRef.getDownloadURL();
      const msg = {
        uid: currentUser.uid,
        name: currentUser.displayName || currentUser.email,
        avatar: currentUser.photoURL || '',
        image: url,
        time: Date.now()
      };
      messagesRef.push(msg);
    } catch (err) {
      alert('Erro ao enviar imagem: ' + err.message);
    }
    imageInput.value = ''; // limpa input
  };

  // √Åudio base64 com grava√ß√£o segurando bot√£o
  audioBtn.addEventListener('mousedown', async () => {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      alert('Navegador n√£o suporta grava√ß√£o de √°udio');
      return;
    }
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.start();
      audioBtn.classList.add('recording');
    } catch (err) {
      alert('Erro ao acessar microfone: ' + err.message);
    }
  });
  audioBtn.addEventListener('mouseup', () => {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
      audioBtn.classList.remove('recording');
      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64audio = reader.result;
          // Enviar audio base64 no banco
          const msg = {
            uid: currentUser.uid,
            name: currentUser.displayName || currentUser.email,
            avatar: currentUser.photoURL || '',
            audio: base64audio,
            time: Date.now()
          };
          messagesRef.push(msg);
        };
        reader.readAsDataURL(audioBlob);
      };
    }
  });
  audioBtn.addEventListener('mouseleave', () => {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
      audioBtn.classList.remove('recording');
    }
  });

  // Habilitar bot√£o enviar quando tem texto
  messageInput.addEventListener('input', () => {
    sendBtn.disabled = !messageInput.value.trim();
    updateTyping(messageInput.value.trim().length > 0);
  });

  // Evento enviar mensagem
  sendBtn.onclick = sendMessage;
  messageInput.addEventListener('keypress', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Atualiza status digitando
  function updateTyping(isTyping) {
    if (!currentUser) return;
    typingRef.child(currentUser.uid).set(isTyping);
    if (typingTimeout) clearTimeout(typingTimeout);
    if (isTyping) {
      typingTimeout = setTimeout(() => {
        typingRef.child(currentUser.uid).set(false);
      }, 3000);
    }
  }

  // Escuta status digitando de outros usu√°rios
  typingRef.on('value', snapshot => {
    const typingUsers = [];
    snapshot.forEach(childSnap => {
      if (childSnap.key !== (currentUser ? currentUser.uid : null) && childSnap.val() === true) {
        typingUsers.push(childSnap.key);
      }
    });
    if (typingUsers.length > 0) {
      typingStatus.textContent = 'Digitando...';
    } else {
      typingStatus.textContent = '';
    }
  });

  // Emojis simples
  const emojis = ['üòÄ','üòÇ','üòç','üòâ','üòé','üò¢','üò≠','üò°','üëç','üôè','üéâ','üí•','üåü','üî•','‚ù§Ô∏è','üíö','üíô','üéà'];
  emojis.forEach(e => {
    const span = document.createElement('span');
    span.textContent = e;
    span.onclick = () => {
      messageInput.value += e;
      sendBtn.disabled = false;
      emojiPicker.style.display = 'none';
      messageInput.focus();
      updateTyping(true);
    };
    emojiPicker.appendChild(span);
  });
  emojiBtn.onclick = () => {
    emojiPicker.style.display = emojiPicker.style.display === 'block' ? 'none' : 'block';
  };

  // Fechar emoji picker ao clicar fora
  document.addEventListener('click', e => {
    if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
      emojiPicker.style.display = 'none';
    }
  });

  // Autentica√ß√£o observador
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      showChat();
      startListeningMessages();
    } else {
      currentUser = null;
      showLogin();
    }
  });

</script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js')
      .then(() => console.log('‚úÖ Service Worker registrado!'))
      .catch(err => console.error('Erro no Service Worker:', err));
  }
</script>

</body>
</html>
