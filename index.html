<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat Firebase - Login com Email/Senha, Foto e √Åudio</title>
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#075e54" />

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #121b22;
      color: #ddd;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #login-screen, #chat-screen {
      display: none;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      flex: 1;
    }
    #login-screen {
      justify-content: center;
      background: #1f2c34;
    }
    #chat-screen {
      background: #1e2a31;
      display: flex;
    }
    input, button {
      padding: 10px;
      margin: 5px 0;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      outline: none;
    }
    input[type="email"], input[type="password"] {
      width: 250px;
      background-color: #233038;
      color: #ddd;
    }
    input[type="file"] {
      color: #ddd;
    }
    button {
      background-color: #25d366;
      color: white;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #1ebe57;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      background: #075e54;
      color: white;
      padding: 10px 20px;
      box-sizing: border-box;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .user-info img {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      background-color: #333;
    }
    #messages {
      flex: 1;
      width: 100%;
      overflow-y: auto;
      padding: 10px 20px;
      box-sizing: border-box;
      scroll-behavior: smooth;
    }
    .msg {
      margin: 10px 0;
      padding: 10px;
      border-radius: 12px;
      max-width: 60%;
      display: flex;
      flex-direction: column;
      word-break: break-word;
    }
    .sent {
      background: #056162;
      align-self: flex-end;
      color: #e1f4f3;
    }
    .received {
      background: #233038;
      align-self: flex-start;
      color: #ddd;
    }
    .msg-header {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85em;
      margin-bottom: 5px;
    }
    .msg-header img {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
    }
    .msg .text {
      white-space: pre-wrap;
    }
    audio {
      margin-top: 8px;
      outline: none;
      width: 100%;
      border-radius: 6px;
      background: #233038;
    }
    img.msg-image {
      max-width: 100%;
      border-radius: 10px;
      margin-top: 8px;
      cursor: pointer;
      box-shadow: 0 0 5px #25d366;
      transition: transform 0.2s ease;
    }
    img.msg-image:hover {
      transform: scale(1.05);
    }
    .input-area {
      display: flex;
      width: 100%;
      padding: 10px 20px;
      background: #233038;
      gap: 8px;
      align-items: center;
      box-sizing: border-box;
    }
    .input-area input[type="text"] {
      flex: 1;
      padding: 12px 15px;
      font-size: 16px;
      border-radius: 20px;
      border: none;
      background-color: #1e2a31;
      color: #ddd;
      outline: none;
    }
    .input-area button {
      padding: 10px 15px;
      font-size: 20px;
      border-radius: 50%;
      background: #25d366;
      border: none;
      color: white;
      cursor: pointer;
      user-select: none;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background-color 0.3s ease;
    }
    .input-area button:hover {
      background-color: #1ebe57;
    }
    #audio-btn.recording {
      background-color: #cc3333 !important;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(204, 51, 51, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(204, 51, 51, 0); }
      100% { box-shadow: 0 0 0 0 rgba(204, 51, 51, 0); }
    }
    #error-message {
      color: #ff6b6b;
      margin-bottom: 10px;
      min-height: 18px;
      text-align: center;
    }
    #typing-status {
      font-style: italic;
      color: #a0d468;
      font-size: 0.9em;
      height: 20px;
      padding-left: 20px;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <div id="login-screen">
    <h2>Entre no Chat</h2>
    <div id="error-message"></div>
    <input type="email" id="email-input" placeholder="Email" />
    <input type="password" id="password-input" placeholder="Senha" />
    <input type="file" id="avatar-input" accept="image/*" />
    <button id="login-btn">Entrar / Registrar</button>
  </div>
  <div id="chat-screen">
    <header>
      <div class="user-info">
        <img id="user-avatar" src="" alt="Foto de perfil" />
        <span id="user-name"></span>
      </div>
      <button id="logout-btn" title="Sair do chat">‚éã</button>
    </header>
    <div id="typing-status"></div>
    <div id="messages"></div>
    <div class="input-area">
      <input type="text" id="message-input" placeholder="Digite uma mensagem" autocomplete="off" />
      <input type="file" id="image-input" accept="image/*" style="display:none;" />
      <button id="image-btn" title="Enviar imagem">üìé</button>
      <button id="audio-btn" title="Gravar √°udio">üéôÔ∏è</button>
      <button id="send-btn" title="Enviar mensagem">‚û§</button>
    </div>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAb3NOMIUO-zQ9QaGIXwV8ty38cN9Yl2Gg",
    authDomain: "chat-on-1-4f38f.firebaseapp.com",
    databaseURL: "https://chat-on-1-4f38f-default-rtdb.firebaseio.com",
    projectId: "chat-on-1-4f38f",
    storageBucket: "chat-on-1-4f38f.appspot.com",
    messagingSenderId: "499742357573",
    appId: "1:499742357573:web:0cf2bed752f4e1cbb74b2c",
    measurementId: "G-BMZW4Q4PDJ"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();
  const messagesRef = db.ref("messages");
  const typingRef = db.ref("typing");

  const loginBtn = document.getElementById('login-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const chatScreen = document.getElementById('chat-screen');
  const loginScreen = document.getElementById('login-screen');
  const emailInput = document.getElementById('email-input');
  const passwordInput = document.getElementById('password-input');
  const avatarInput = document.getElementById('avatar-input');
  const userAvatar = document.getElementById('user-avatar');
  const userNameDisplay = document.getElementById('user-name');
  const messagesContainer = document.getElementById('messages');
  const messageInput = document.getElementById('message-input');
  const sendBtn = document.getElementById('send-btn');
  const audioBtn = document.getElementById('audio-btn');
  const errorMessage = document.getElementById('error-message');
  const imageBtn = document.getElementById('image-btn');
  const imageInput = document.getElementById('image-input');
  const typingStatus = document.getElementById('typing-status');

  let currentUser = null;
  let messagesListener = null;
  let mediaRecorder = null;
  let audioChunks = [];
  let typingTimeout;

  function showLogin() {
    loginScreen.style.display = 'flex';
    chatScreen.style.display = 'none';
  }

  function showChat() {
    loginScreen.style.display = 'none';
    chatScreen.style.display = 'flex';
    userNameDisplay.textContent = currentUser.displayName || currentUser.email;
    userAvatar.src = currentUser.photoURL || 'https://i.imgur.com/xx7JfUD.png';
    messageInput.focus();
  }

  async function uploadAvatar(uid, file) {
    const avatarRef = storage.ref().child(`avatars/${uid}.jpg`);
    await avatarRef.put(file);
    return await avatarRef.getDownloadURL();
  }

  loginBtn.onclick = async () => {
    errorMessage.textContent = '';
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    const avatarFile = avatarInput.files[0];

    if (!email || !password) {
      errorMessage.textContent = 'Email e senha s√£o obrigat√≥rios';
      return;
    }

    try {
      const cred = await auth.signInWithEmailAndPassword(email, password);
      currentUser = cred.user;
      if (!currentUser.photoURL && avatarFile) {
        const url = await uploadAvatar(currentUser.uid, avatarFile);
        await currentUser.updateProfile({ photoURL: url });
      }
      showChat();
    } catch (e) {
      if (e.code === 'auth/user-not-found') {
        try {
          const cred = await auth.createUserWithEmailAndPassword(email, password);
          currentUser = cred.user;
          const displayName = email.split('@')[0];
          let photoURL = 'https://i.imgur.com/xx7JfUD.png';
          if (avatarFile) {
            photoURL = await uploadAvatar(currentUser.uid, avatarFile);
          }
          await currentUser.updateProfile({ displayName, photoURL });
          showChat();
        } catch (regErr) {
          errorMessage.textContent = regErr.message;
        }
      } else {
        errorMessage.textContent = e.message;
      }
    }
  };

  function renderMessage(key, msg) {
    if (!msg.text && !msg.audio && !msg.image) return;

    const isSent = currentUser && msg.uid === currentUser.uid;
    const div = document.createElement('div');
    div.className = 'msg ' + (isSent ? 'sent' : 'received');

    const header = document.createElement('div');
    header.className = 'msg-header';

    const img = document.createElement('img');
    img.src = msg.avatar || 'https://i.imgur.com/xx7JfUD.png';

    const name = document.createElement('span');
    name.textContent = msg.name;

    const time = document.createElement('span');
    const d = new Date(msg.time);
    time.textContent = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    header.appendChild(img);
    header.appendChild(name);
    header.appendChild(time);

    div.appendChild(header);

    if (msg.text) {
      const text = document.createElement('div');
      text.className = 'text';
      text.textContent = msg.text;
      div.appendChild(text);
    }

    if (msg.audio) {
      const audio = document.createElement('audio');
      audio.controls = true;
      audio.src = msg.audio;
      div.appendChild(audio);
    }

    if (msg.image) {
      const image = document.createElement('img');
      image.src = msg.image;
      image.className = 'msg-image';
      image.alt = "Imagem enviada";
      image.onclick = () => window.open(msg.image, '_blank');
      div.appendChild(image);
    }

    messagesContainer.appendChild(div);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function startListeningMessages() {
    messagesContainer.innerHTML = '';
    if (messagesListener) {
      messagesRef.off('child_added', messagesListener);
    }
    messagesListener = messagesRef.on('child_added', snap => {
      renderMessage(snap.key, snap.val());
    });
  }

  function sendMessage(text) {
    if (!text || !currentUser) return;
    const msg = {
      uid: currentUser.uid,
      name: currentUser.displayName || currentUser.email,
      avatar: currentUser.photoURL || '',
      text,
      time: Date.now()
    };
    messagesRef.push(msg);
  }

  sendBtn.onclick = () => {
    const text = messageInput.value.trim();
    if (text) {
      sendMessage(text);
      messageInput.value = '';
      updateTyping(false);
    }
  };

  messageInput.addEventListener('keypress', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      sendBtn.click();
    } else {
      updateTyping(true);
    }
  });

  // TYPING STATUS
  function updateTyping(isTyping) {
    if (!currentUser) return;
    typingRef.child(currentUser.uid).set(isTyping);
    if (typingTimeout) clearTimeout(typingTimeout);
    if (isTyping) {
      typingTimeout = setTimeout(() => updateTyping(false), 3000);
    }
  }

  typingRef.on('value', snap => {
    if (!currentUser) {
      typingStatus.textContent = '';
      return;
    }
    const typingUsers = snap.val() || {};
    const otherTyping = Object.keys(typingUsers).some(uid => uid !== currentUser.uid && typingUsers[uid]);
    typingStatus.textContent = otherTyping ? 'Digitando...' : '';
  });

  // AUDIO RECORDING
  async function startAudioRecording() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      alert('Este navegador n√£o suporta grava√ß√£o de √°udio.');
      return;
    }

    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.start();
      audioChunks = [];

      audioBtn.classList.add('recording');
      audioBtn.title = "Gravando... Clique para parar";

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

      mediaRecorder.onstop = async () => {
        audioBtn.classList.remove('recording');
        audioBtn.title = "Gravar √°udio";

        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const audioFile = new File([audioBlob], `audio_${Date.now()}.webm`);

        try {
          const audioRef = storage.ref().child(`audios/${currentUser.uid}_${Date.now()}.webm`);
          await audioRef.put(audioFile);
          const audioURL = await audioRef.getDownloadURL();

          const msg = {
            uid: currentUser.uid,
            name: currentUser.displayName || currentUser.email,
            avatar: currentUser.photoURL || '',
            audio: audioURL,
            time: Date.now()
          };

          messagesRef.push(msg);
        } catch(err) {
          alert('Erro ao enviar √°udio: ' + err.message);
          console.error('Erro upload √°udio:', err);
        }
      };

      // Clique no bot√£o para parar grava√ß√£o antes dos 30s
      audioBtn.onclick = () => {
        if (mediaRecorder && mediaRecorder.state === "recording") {
          mediaRecorder.stop();
        }
        // Reatribuir o clique para iniciar nova grava√ß√£o
        audioBtn.onclick = startAudioRecording;
      };

      // Para grava√ß√£o automaticamente ap√≥s 30 segundos
      setTimeout(() => {
        if (mediaRecorder && mediaRecorder.state === "recording") {
          mediaRecorder.stop();
          audioBtn.classList.remove('recording');
          audioBtn.title = "Gravar √°udio";
          audioBtn.onclick = startAudioRecording;
        }
      }, 30000);

    } catch (error) {
      alert('Erro ao acessar o microfone: ' + error.message);
    }
  }

  audioBtn.onclick = startAudioRecording;

  // IMAGEM - UPLOAD E ENVIO
  imageBtn.onclick = () => {
    imageInput.click();
  };

  imageInput.onchange = async () => {
    if (!currentUser) return;
    const file = imageInput.files[0];
    if (!file) return;

    const ext = file.name.split('.').pop().toLowerCase();
    if (!['jpg','jpeg','png','gif','bmp','webp'].includes(ext)) {
      alert('Tipo de arquivo n√£o suportado.');
      return;
    }

    const storageRef = storage.ref();
    const imageRef = storageRef.child(`images/${currentUser.uid}_${Date.now()}.${ext}`);

    try {
      await imageRef.put(file);
      const url = await imageRef.getDownloadURL();

      const msg = {
        uid: currentUser.uid,
        name: currentUser.displayName || currentUser.email,
        avatar: currentUser.photoURL || '',
        image: url,
        time: Date.now()
      };
      messagesRef.push(msg);
      imageInput.value = ''; // resetar input
    } catch(err) {
      alert('Erro ao enviar imagem: ' + err.message);
      console.error('Erro upload imagem:', err);
    }
  };

  // LOGOUT
  logoutBtn.onclick = async () => {
    if (confirm('Deseja sair do chat?')) {
      await auth.signOut();
      currentUser = null;
      messagesContainer.innerHTML = '';
      if (messagesListener) {
        messagesRef.off('child_added', messagesListener);
        messagesListener = null;
      }
      showLogin();
    }
  };

  // AUTENTICA√á√ÉO - STATUS
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      showChat();
      startListeningMessages();
    } else {
      currentUser = null;
      showLogin();
    }
  });

</script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js')
      .then(() => console.log('‚úÖ Service Worker registrado!'))
      .catch(err => console.error('Erro no Service Worker:', err));
  }
</script>
</body>
</html>
