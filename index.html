<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meu Chat PWA</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#075e54" />

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <style>
    body { font-family: Arial; margin: 0; }
    #login, #chat { display: none; padding: 20px; }
    #chat { background: #ece5dd; height: 100vh; display: flex; flex-direction: column; }
    header { background: #075e54; color: #fff; padding: 10px; display: flex; justify-content: space-between; }
    #messages { flex: 1; overflow-y: auto; padding: 10px; }
    .message { margin: 10px 0; padding: 10px; border-radius: 5px; }
    .own { background: #dcf8c6; text-align: right; }
    .other { background: #fff; text-align: left; }
    footer { display: flex; }
    input, button { padding: 10px; font-size: 16px; }
    input { flex: 1; }
  </style>
</head>
<body>
  <div id="login">
    <h2>Entrar / Registrar</h2>
    <input type="email" id="email" placeholder="Email" /><br />
    <input type="password" id="senha" placeholder="Senha" /><br />
    <button id="entrar">Entrar / Registrar</button>
  </div>

  <div id="chat">
    <header>
      <span id="usuario"></span>
      <button id="sair">Sair</button>
    </header>
    <div id="messages"></div>
    <footer>
      <input id="mensagem" placeholder="Digite sua mensagem..." />
      <button id="enviar">Enviar</button>
    </footer>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAb3NOMIUO-zQ9QaGIXwV8ty38cN9Yl2Gg",
      authDomain: "chat-on-1-4f38f.firebaseapp.com",
      databaseURL: "https://chat-on-1-4f38f-default-rtdb.firebaseio.com",
      projectId: "chat-on-1-4f38f",
      storageBucket: "chat-on-1-4f38f.appspot.com",
      messagingSenderId: "499742357573",
      appId: "1:499742357573:web:0cf2bed752f4e1cbb74b2c",
      measurementId: "G-BMZW4Q4PDJ"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const loginDiv = document.getElementById('login');
    const chatDiv = document.getElementById('chat');
    const emailInput = document.getElementById('email');
    const senhaInput = document.getElementById('senha');
    const entrarBtn = document.getElementById('entrar');
    const sairBtn = document.getElementById('sair');
    const usuarioSpan = document.getElementById('usuario');
    const mensagemInput = document.getElementById('mensagem');
    const enviarBtn = document.getElementById('enviar');
    const messagesDiv = document.getElementById('messages');

    entrarBtn.onclick = async () => {
      const email = emailInput.value.trim();
      const senha = senhaInput.value.trim();
      if (!email || !senha) return alert('Preencha todos os campos');
      try {
        await auth.signInWithEmailAndPassword(email, senha);
      } catch (err) {
        if (err.code === 'auth/user-not-found') {
          try {
            await auth.createUserWithEmailAndPassword(email, senha);
            alert('Conta criada com sucesso!');
          } catch (e) {
            alert(e.message);
          }
        } else {
          alert(err.message);
        }
      }
    };

    sairBtn.onclick = () => auth.signOut();

    enviarBtn.onclick = () => {
      const texto = mensagemInput.value.trim();
      if (!texto) return;
      const user = auth.currentUser;
      db.ref('mensagens').push({
        uid: user.uid,
        nome: user.email,
        texto,
        hora: Date.now()
      });
      mensagemInput.value = '';
    };

    auth.onAuthStateChanged(user => {
      if (user) {
        loginDiv.style.display = 'none';
        chatDiv.style.display = 'flex';
        usuarioSpan.textContent = user.email;
        messagesDiv.innerHTML = '';
        db.ref('mensagens').off();
        db.ref('mensagens').on('child_added', snap => {
          const msg = snap.val();
          const div = document.createElement('div');
          div.className = 'message ' + (msg.uid === user.uid ? 'own' : 'other');
          div.textContent = msg.nome + ': ' + msg.texto;
          messagesDiv.appendChild(div);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });
      } else {
        loginDiv.style.display = 'block';
        chatDiv.style.display = 'none';
      }
    });
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('Service Worker registrado'))
        .catch(err => console.error('Erro ao registrar SW', err));
    }
  </script>
</body>
</html>
